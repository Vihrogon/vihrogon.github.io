<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>snake</title>
    <style>
      body {
        margin: 0px;
        background-color: black;
      }
    </style>
    <script>
      window.addEventListener('load', function (){
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        var width = window.innerWidth;
        var height = window.innerHeight;
        var box = 12;
        //sets the size of the canvas to be the smaller between width and height and a multiple of the box size
        //var size = (width < height) ? (width - width % box) / box : (height - height % box) / box;
        var size = 40;
        var moves = ['up'];
        var snake = [{x: 10, y: 10}, {x: 10, y: 11}, {x: 10, y: 12}, {x: 10, y: 13}];
        var apple = {x: 9, y: 10};
        var speed = 4;
        var highscore = 0;
        var gameover = false;
        //
        var time = window.setInterval(function (){
          move();
          draw();
          score();
        },1000 / speed);
        canvas.width = size * box;
        canvas.height = size * box + size * box / 2;
        document.body.appendChild(canvas);
        
        window.addEventListener('keydown', function (){
          test(event.key);console.log(event.key)
        });
        //
        function test (key){
          //if (key == )
          if (moves[moves.length - 1] != 'up' && moves[moves.length - 1] != 'down'){
            if (key == 'ArrowUp')
              moves.push('up')
            if (key == 'ArrowDown')
              moves.push('down')
          }
          if (moves[moves.length - 1] != 'left' && moves[moves.length - 1] != 'right'){
            if (key == 'ArrowLeft')
              moves.push('left')
            if (key == 'ArrowRight')
              moves.push('right')
          }
        }
         //
        function score(){
          if (localStorage.highscore){
            if (localStorage.highscore < highscore){
              localStorage.highscore = highscore;
            }
          } else {
            localStorage.highscore = 0;
          }
        }
        //
        function move(){
          let x = 0;
          let y = 0;
          //determines the current direction
          if (moves[0] == 'up'){
            x = 0;
            y = -1;
          }
          if (moves[0] == 'down'){
            x = 0;
            y = 1;
          }
          if (moves[0] == 'left'){
            x = -1;
            y = 0;
          }
          if (moves[0] == 'right'){
            x = 1;
            y = 0;
          }
          //moves the snake one box in the current direction
          snake.unshift({x: snake[0].x + x, y: snake[0].y + y});
          snake.pop();
          //detects collision with the walls
          if (snake[0].x < 1){
            snake[0].x = size - 2;
          }
          if (snake[0].x > size - 2){
            snake[0].x = 1;
          }
          if (snake[0].y < 1){
            snake[0].y = size - 2;
          }
          if (snake[0].y > size - 2){
            snake[0].y = 1;
          }
          //detects collision with the tail
          for (let n = 4; n < snake.length; n++){
            if (snake[0].x == snake[n].x && snake[0].y == snake[n].y){
              //snake.splice(n, snake.length);
              clearInterval(time);
              gameover = true;
            }
          }
          //detects collision with the apple
          if (snake[0].x == apple.x && snake[0].y == apple.y){
            snake.push({x: apple.x, y: apple.y});
            apple.x = rr(1, size - 2);
            apple.y = rr(1, size - 2);
            //score and speed
            highscore += 10 * speed;
            speed += 0.5;console.log(speed);
            clearInterval(time);
            time = window.setInterval(function (){
              move();
              draw();
              score();
            },1000 / speed);
          }
          
          //
          if (moves.length > 1){
            moves.shift();
          }
        }
        //
        function draw(){
          //background
          ctx.beginPath();
          ctx.rect(0, 0, size * box, size * box + size * box / 2);
          ctx.fillStyle = 'black';
          ctx.fill();
          ctx.closePath();
          //border
          ctx.beginPath();
          ctx.rect(box, box, size * box - box * 2, size * box - box * 2);
          ctx.strokeStyle = 'white';
          ctx.stroke();
          ctx.closePath();
          //apple
          ctx.beginPath();
          ctx.rect(box * apple.x + 1, box * apple.y + 1, box - 2, box - 2);
          ctx.fillStyle = 'red';
          ctx.fill();
          ctx.closePath();
          //snake
          for (let n = 0; n < snake.length; n++){
            ctx.beginPath();
            ctx.rect(box * snake[n].x + 1, box * snake[n].y + 1, box - 2, box - 2);
            ctx.fillStyle = 'green';
            ctx.fill();
            ctx.closePath();
          }
          //gameover
          if (gameover){
            ctx.beginPath();
            ctx.font = box * 2 + 'px courier';
            ctx.fillStyle = 'red';
            ctx.fillText('GAME OVER', box * size / 2 - box * 5, size * box / 2);
            ctx.closePath();
          }
          //score
          ctx.beginPath();
          ctx.font = box + 'px courier';
          ctx.fillStyle = 'orange';
          ctx.fillText('your score : ' + highscore, box, size * box + box);
          ctx.closePath();
          //highscore
           ctx.beginPath();
          ctx.font = box + 'px courier';
          ctx.fillStyle = 'orange';
          ctx.fillText('high score : ' + localStorage.highscore, box, size * box + box * 2);
          ctx.closePath();
          //control
          ctx.beginPath();
          ctx.arc(size * box / 2, size * box + size * box / 4, size * box / 5, 0, 2 * Math.PI);
          ctx.fillStyle = '#eee';
          ctx.fill();
          ctx.closePath();
          
          ctx.beginPath();
          ctx.arc(size * box / 2, size * box + size * box / 4, size * box / 8, 0, 2 * Math.PI);
          ctx.fillStyle = '#777';
          ctx.fill();
          ctx.closePath();
          
          ctx.beginPath();
          ctx.arc(size * box / 2, size * box + size * box / 4, size * box / 16, 0, 2 * Math.PI);
          ctx.fillStyle = '#555';
          ctx.fill();
          ctx.closePath();
          
          ctx.beginPath();
          ctx.arc(size * box / 2, size * box + size * box / 4, size * box / 8, 0, 2 * Math.PI);
          ctx.strokeStyle = '#444';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.closePath();
          
          ctx.beginPath();
          ctx.arc(size * box / 2, size * box + size * box / 4, size * box / 16, 0, 2 * Math.PI);
          ctx.strokeStyle = '#444';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.closePath();
        }
        //returns a random number in the range of and including n1 and n2 and (if given) excluding n3
        function rr(n1, n2, n3){
          var num = Math.floor(Math.random() * (n2 - n1 + 1) + n1);
          if (arguments.length == 3 && num == n3){
            return this.rr(n1, n2, n3);
          }else {
            return num;
          }
        }
        
        draw();
        score();
      });
    </script>
  </head>
  <body>
    
  </body>
</html>